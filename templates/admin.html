<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard ‚Äî RMLCanteen</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">üçΩÔ∏è RMLCanteen Admin</div>
    <nav class="nav">
      <a href="#" onclick="logoutUser()">üö™ Logout</a>
    </nav>
  </header>

  <!-- Notification Container -->
  <div id="notificationContainer" style="position: fixed; top: 80px; right: 20px; z-index: 10000; max-width: 400px;"></div>

  <main>
    <!-- Statistics Dashboard -->
    <div class="stats-grid" id="statsGrid"></div>

    <div class="content-card">
      <div class="tab-buttons">
        <button id="tabOrders" class="active" onclick="switchTab('orders')">
          üì¶ Orders <span class="tab-badge" id="ordersBadge">0</span>
        </button>
        <button id="tabMenu" onclick="switchTab('menu')">
          üçΩÔ∏è Menu Management
        </button>
        <button id="tabUsers" onclick="switchTab('users')">
          üë• User Management <span class="tab-badge" id="usersBadge">0</span>
        </button>
      </div>

      <!-- ORDER STATUS UPDATE TAB -->
      <section id="ordersSection" class="tab-content active">
        <h2>üì¶ Order Management</h2>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="üîç Search by name, contact, or order ID..." 
            oninput="filterOrders()"
          >
        </div>

        <div id="ordersList"></div>
      </section>

      <!-- MENU TAB -->
      <section id="menuSection" class="tab-content">
        <h2>üçΩÔ∏è Menu Management</h2>
        <p style="color: var(--text); margin-bottom: 20px;">
          Add, edit, or remove menu items. Control what items are available for customers.
        </p>
        
        <!-- Add New Item Form -->
        <div class="card" style="margin-bottom: 20px; background: #fff8f1;">
          <h3 style="margin-top: 0;">‚ûï Add New Menu Item</h3>
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
            <div>
              <label class="input-label">Item Name</label>
              <input type="text" id="newItemName" placeholder="e.g., Chicken Adobo" style="width: 100%;">
            </div>
            <div>
              <label class="input-label">Price (‚Ç±)</label>
              <input type="number" id="newItemPrice" placeholder="50" min="0" step="0.01" style="width: 100%;">
            </div>
            <div>
              <label class="input-label">Category</label>
              <select id="newItemCategory" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="budget">Budget Meals</option>
                <option value="foods">Foods</option>
                <option value="drinks">Drinks</option>
              </select>
            </div>
            <div>
              <label class="input-label">Stock Quantity</label>
              <input type="number" id="newItemQuantity" placeholder="0" min="0" value="0" style="width: 100%;">
            </div>
            <button class="btn" onclick="addMenuItem()" style="height: fit-content;">Add Item</button>
          </div>
        </div>
        
        <div id="adminMenuList"></div>
      </section>

      <!-- USER MANAGEMENT TAB -->
      <section id="usersSection" class="tab-content">
        <h2>üë• User Management</h2>
        <p style="color: var(--text); margin-bottom: 20px;">
          Review and approve user registrations. Users must be approved before they can login.
        </p>
        
        <div id="usersList"></div>
      </section>
    </div>
  </main>

  <script src="/static/script.js"></script>
  <script>
    // Global state for filtering
    let allOrders = [];
    let filteredOrders = [];

    /* -------- Statistics Dashboard -------- */
    async function renderStats() {
      const orders = allOrders;
      const stats = {
        total: orders.length,
        pending: orders.filter(o => o.status === 'Pending').length,
        preparing: orders.filter(o => o.status === 'Preparing').length,
        delivery: orders.filter(o => o.status === 'Out for Delivery').length,
        delivered: orders.filter(o => o.status === 'Delivered').length,
        revenue: orders.reduce((sum, o) => sum + Number(o.total || 0), 0)
      };

      const statsGrid = document.getElementById('statsGrid');
      if (!statsGrid) return;

      statsGrid.innerHTML = `
        <div class="stat-card total">
          <div class="stat-label">üìä Total Orders</div>
          <div class="stat-number">${stats.total}</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-label">‚è≥ Pending</div>
          <div class="stat-number">${stats.pending}</div>
        </div>
        <div class="stat-card preparing">
          <div class="stat-label">üë®‚Äçüç≥ Preparing</div>
          <div class="stat-number">${stats.preparing}</div>
        </div>
        <div class="stat-card delivery">
          <div class="stat-label">üöö Out for Delivery</div>
          <div class="stat-number">${stats.delivery}</div>
        </div>
        <div class="stat-card delivered">
          <div class="stat-label">‚úÖ Delivered</div>
          <div class="stat-number">${stats.delivered}</div>
        </div>
        <div class="stat-card total">
          <div class="stat-label">üí∞ Total Revenue</div>
          <div class="stat-number">‚Ç±${stats.revenue.toFixed(2)}</div>
        </div>
      `;

      // Update badge
      const badge = document.getElementById('ordersBadge');
      if (badge) badge.textContent = stats.total;
    }

    /* -------- Tab Switching -------- */
    function switchTab(tab) {
      document.getElementById('tabOrders').classList.remove('active');
      document.getElementById('tabMenu').classList.remove('active');
      document.getElementById('tabUsers').classList.remove('active');
      document.getElementById('ordersSection').classList.remove('active');
      document.getElementById('menuSection').classList.remove('active');
      document.getElementById('usersSection').classList.remove('active');

      if (tab === 'orders') {
        document.getElementById('tabOrders').classList.add('active');
        document.getElementById('ordersSection').classList.add('active');
        renderAdminOrders();
      } else if (tab === 'menu') {
        document.getElementById('tabMenu').classList.add('active');
        document.getElementById('menuSection').classList.add('active');
        renderAdminMenuList();
      } else if (tab === 'users') {
        document.getElementById('tabUsers').classList.add('active');
        document.getElementById('usersSection').classList.add('active');
        renderAdminUsers();
      }
    }

    /* -------- Render Orders (API) -------- */
    async function renderAdminOrders() {
      try {
        const response = await fetch('/orders');
        const orders = await response.json();
        allOrders = orders.reverse();
        filteredOrders = [...allOrders];
        renderStats();
        displayOrders();
        
        // Update orders badge
        const pendingCount = allOrders.filter(o => o.status === 'Pending').length;
        const badge = document.getElementById('ordersBadge');
        if (badge) {
          badge.textContent = pendingCount;
        }
      } catch(error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = '<p class="muted">Failed to load orders</p>';
      }
    }

    // Calculate sequential order numbers (only for active orders, not delivered)
    function getOrderNumberMap() {
      // Get all active orders (not delivered), sorted by creation time (oldest first)
      const activeOrders = allOrders
        .filter(o => o.status !== 'Delivered')
        .sort((a, b) => {
          const dateA = new Date(a.created_at || 0);
          const dateB = new Date(b.created_at || 0);
          return dateA - dateB; // Oldest first
        });
      
      // Create a map: orderId -> sequential number
      const orderNumberMap = {};
      activeOrders.forEach((order, index) => {
        orderNumberMap[order.id] = index + 1; // Start from 1
      });
      
      return orderNumberMap;
    }

    function displayOrders() {
      const container = document.getElementById('ordersList');
      if (!container) return;

      // Get sequential order numbers
      const orderNumberMap = getOrderNumberMap();

      if (filteredOrders.length === 0) {
        const hasFilters = document.getElementById('searchInput')?.value || 
                          document.getElementById('statusFilter')?.value !== 'all';
        if (hasFilters) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <div class="empty-state-text">No orders match your search criteria</div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì¶</div>
              <div class="empty-state-text">No orders yet</div>
            </div>
          `;
        }
        return;
      }

      container.innerHTML = filteredOrders.map((o, displayIdx) => {
        const actualIdx = allOrders.indexOf(o);
        let badgeClass = "";
        switch (o.status) {
          case "Pending": badgeClass = "status-pending"; break;
          case "Preparing": badgeClass = "status-preparing"; break;
          case "Out for Delivery": badgeClass = "status-delivery"; break;
          case "Delivered": badgeClass = "status-delivered"; break;
          default: badgeClass = "status-pending";
        }

        // Get sequential order number (only for active orders)
        const sequentialNumber = orderNumberMap[o.id];
        const displayOrderNumber = sequentialNumber ? sequentialNumber : `#${o.id}`;
        const orderNumberLabel = sequentialNumber ? `Order #${sequentialNumber}` : `Order #${o.id} (Completed)`;

        const buyerName = o.fullname || o.name || "N/A";
        const buyerContact = o.contact || o.number || "N/A";
        const buyerAddress = o.location || o.address || "N/A";
        const orderDate = new Date(o.created_at || Date.now()).toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Parse items if it's a string (from database)
        const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;

        return `
          <div class="order-card" data-order-id="${o.id}" data-sequential-number="${sequentialNumber || ''}">
            <div class="order-header">
              <div>
                <div class="order-id">${orderNumberLabel}</div>
                <div class="order-date">${orderDate}</div>
              </div>
              <span class="status-badge ${badgeClass}">${o.status}</span>
            </div>

            <div class="buyer-info">
              <p><strong>üë§ Customer:</strong> ${buyerName}</p>
              <p><strong>üìû Contact:</strong> ${buyerContact}</p>
              <p><strong>üìç Address:</strong> ${buyerAddress}</p>
            </div>

            <div class="order-items">
              <strong>üìã Items:</strong><br>
              ${items.map(it => `‚Ä¢ ${it.name} √ó ${it.qty} (‚Ç±${(Number(it.price) * Number(it.qty)).toFixed(2)})`).join('<br>')}
            </div>

            <div class="order-total">
              üí∞ Total: ‚Ç±${Number(o.total).toFixed(2)}
            </div>

            <div class="status-buttons">
              <select class="status-select" onchange="updateOrderStatus(${o.id}, this.value)" value="${o.status || 'Pending'}">
                <option value="Pending" ${(!o.status || o.status === 'Pending') ? 'selected' : ''}>‚è≥ Pending</option>
                <option value="Preparing" ${o.status === 'Preparing' ? 'selected' : ''}>üë®‚Äçüç≥ Preparing</option>
                <option value="Out for Delivery" ${o.status === 'Out for Delivery' ? 'selected' : ''}>üöö Out for Delivery</option>
                <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
              </select>
              ${o.status === 'Pending' ? `
                <button class="btn delete small" onclick="cancelOrder(${o.id})">‚ùå Cancel</button>
              ` : ''}
              <button class="btn small print" onclick="printSingleOrder(${o.id})">üñ®Ô∏è Print</button>
            </div>
          </div>
        `;
      }).join('');
    }

    /* -------- Filter Orders -------- */
    function filterOrders() {
      const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

      filteredOrders = allOrders.filter(o => {
        const buyerName = (o.fullname || o.name || '').toLowerCase();
        const buyerContact = (o.contact || o.number || '').toLowerCase();
        const orderId = (o.id || '').toLowerCase();
        
        const matchesSearch = !searchTerm || 
          buyerName.includes(searchTerm) || 
          buyerContact.includes(searchTerm) ||
          orderId.includes(searchTerm);
        
        return matchesSearch;
      });

      displayOrders();
    }

    /* -------- Update Status (API) -------- */
    async function updateOrderStatus(orderId, status) {
      if (!status) {
        // Invalid selection, reset
        await renderAdminOrders();
        return;
      }
      
      // Get sequential order number before update
      const orderNumberMap = getOrderNumberMap();
      const sequentialNumber = orderNumberMap[orderId] || orderId;
      
      let response;
      try {
        response = await fetch(`/orders/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });
      } catch(networkError) {
        // Network/connection error
        console.error('Network error updating order:', networkError);
        alert('Failed to update order status. Please check your connection and try again.');
        await renderAdminOrders();
        return;
      }

      // Check if response is successful
      if (!response.ok) {
        // Handle error response
        let errorMessage = `Server returned ${response.status}: ${response.statusText}`;
        try {
          const errorData = await response.json();
          errorMessage = errorData.detail || errorMessage;
        } catch(e) {
          // If we can't parse error, use status text
          console.log('Could not parse error response:', e);
        }
        alert(`Failed to update order status: ${errorMessage}`);
        await renderAdminOrders();
        return;
      }

      // Success - consume response body (ignore parsing errors)
      try {
        await response.json();
      } catch(e) {
        // Response parsing failed, but status was OK - that's fine
        // This can happen if response is empty or malformed, but update succeeded
        console.log('Response body note (update succeeded):', e);
      }

      // Success - update the UI silently
      await renderAdminOrders();
      filterOrders();
    }

    /* -------- Cancel Order (only for Pending orders) -------- */
    async function cancelOrder(orderId) {
      // Get sequential order number for confirmation
      const orderNumberMap = getOrderNumberMap();
      const sequentialNumber = orderNumberMap[orderId] || orderId;
      if (!confirm(`‚ö†Ô∏è Are you sure you want to cancel Order #${sequentialNumber}?\n\nThis action cannot be undone.`)) return;
      
      try {
        const response = await fetch(`/orders/${orderId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        // Read response once
        let responseData = null;
        try {
          const responseText = await response.text();
          if (responseText) {
            responseData = JSON.parse(responseText);
          }
        } catch(parseError) {
          // If parsing fails, that's okay - we'll check status code
          console.log('Response parse note:', parseError);
        }

        if (!response.ok) {
          // Handle error response
          const errorMessage = responseData?.detail || `Server returned ${response.status}: ${response.statusText}`;
          alert(`Failed to cancel order: ${errorMessage}`);
          return;
        }

        // Success - show message and refresh
        alert('‚úÖ Order cancelled successfully!');
        
        // Refresh orders list (wrap in try-catch to prevent errors from showing to user)
        try {
          await renderAdminOrders();
          filterOrders();
        } catch(refreshError) {
          console.error('Error refreshing orders after cancel:', refreshError);
          // Don't show error to user - cancellation was successful, just refresh failed
        }
      } catch(error) {
        console.error('Error cancelling order:', error);
        alert('Failed to cancel order. Please check your connection and try again.');
      }
    }

    /* -------- Edit Order (only for Pending orders) -------- */
    async function editOrder(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) {
        alert('Order not found');
        return;
      }

      if (order.status !== 'Pending') {
        alert('Only orders with "Pending" status can be edited.');
        return;
      }

      // Parse items if it's a string
      const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
      
      // Create edit modal
      const modal = document.createElement('div');
      modal.id = 'editOrderModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative;">
          <button onclick="document.getElementById('editOrderModal').remove()" 
                  style="position: absolute; top: 12px; right: 12px; background: #f44336; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; font-weight: bold;">√ó</button>
          
          <h2 style="margin: 0 0 20px 0; color: #8b4513;">‚úèÔ∏è Edit Order #${orderId}</h2>
          
          <form id="editOrderForm" onsubmit="saveOrderEdit(event, ${orderId})">
            <div style="margin-bottom: 16px;">
              <label class="input-label">Customer Name (First Middle Last)</label>
              <input type="text" id="editFullname" value="${(order.fullname || order.name || '').replace(/"/g, '&quot;')}" 
                     placeholder="First Name Middle Name Last Name"
                     required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label class="input-label">Contact Number (11 digits)</label>
              <input type="tel" id="editContact" value="${(order.contact || order.number || '').replace(/"/g, '&quot;')}" 
                     placeholder="09XXXXXXXXX" maxlength="11" pattern="[0-9]{11}"
                     oninput="this.value = this.value.replace(/\D/g, '').slice(0, 11)"
                     required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 16px;">
              <label class="input-label">Address / Location</label>
              <textarea id="editLocation" required 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-height: 80px;">${(order.location || order.address || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label class="input-label">Order Items</label>
              <div id="editItemsList" style="border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #f9f9f9;">
                ${items.map((item, idx) => {
                  const safeName = (item.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                  return `
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px;">
                    <div style="flex: 1;">
                      <strong>${safeName}</strong><br>
                      <span style="color: var(--muted); font-size: 0.9rem;">‚Ç±${Number(item.price).toFixed(2)} √ó 
                      <input type="number" id="editQty_${idx}" value="${item.qty}" min="1" 
                             style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                             onchange="updateEditTotal()">
                      </span>
                    </div>
                    <button type="button" class="btn delete small" onclick="removeEditItem(${idx})">Remove</button>
                  </div>
                `;
                }).join('')}
              </div>
              <div style="margin-top: 12px;">
                <button type="button" class="btn small ghost" onclick="addEditItem()">+ Add Item</button>
              </div>
            </div>
            
            <div style="margin-bottom: 20px; padding: 12px; background: #fff8f1; border-radius: 8px; border: 1px solid #8b4513;">
              <strong>üí∞ Total: ‚Ç±<span id="editTotal">${Number(order.total).toFixed(2)}</span></strong>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" class="btn ghost" onclick="document.getElementById('editOrderModal').remove()">Cancel</button>
              <button type="submit" class="btn">üíæ Save Changes</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Store original items for calculations
      window.editOrderData = {
        items: items.map(item => ({...item})),
        orderId: orderId
      };
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    async function saveOrderEdit(event, orderId) {
      event.preventDefault();
      
      const fullname = document.getElementById('editFullname').value.trim();
      const contact = document.getElementById('editContact').value.trim();
      const location = document.getElementById('editLocation').value.trim();
      
      if (!fullname || !contact || !location) {
        alert('Please fill in all required fields.');
        return;
      }
      
      // Validate full name: must have at least 3 words (First, Middle, Last)
      const nameWords = fullname.split(/\s+/).filter(word => word.length > 0);
      if(nameWords.length < 3) {
        alert('Please enter full name: First Name, Middle Name, and Last Name (at least 3 words).');
        document.getElementById('editFullname').focus();
        return;
      }
      
      // Validate contact number: must be exactly 11 digits
      const contactDigits = contact.replace(/\D/g, ''); // Remove non-digits
      if(contactDigits.length !== 11) {
        alert('Contact number must be exactly 11 digits (e.g., 09123456789).');
        document.getElementById('editContact').focus();
        return;
      }
      
      // Collect items with quantities
      const items = [];
      let total = 0;
      const DELIVERY_FEE = 10;
      
      for (let i = 0; i < window.editOrderData.items.length; i++) {
        const qtyInput = document.getElementById(`editQty_${i}`);
        if (qtyInput && qtyInput.parentElement.parentElement.parentElement) {
          const qty = parseInt(qtyInput.value) || 0;
          if (qty > 0) {
            const item = window.editOrderData.items[i];
            items.push({
              id: item.id,
              name: item.name,
              price: Number(item.price),
              qty: qty
            });
            total += Number(item.price) * qty;
          }
        }
      }
      
      if (items.length === 0) {
        alert('Order must have at least one item.');
        return;
      }
      
      total += DELIVERY_FEE;
      
      try {
        const response = await fetch(`/orders/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fullname: fullname.trim(),
            contact: contactDigits, // Use validated digits-only contact
            location: location.trim(),
            items: items,
            total: total
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          alert(`Failed to update order: ${errorData.detail || 'Unknown error'}`);
          return;
        }
        
        alert('‚úÖ Order updated successfully!');
        document.getElementById('editOrderModal').remove();
        await renderAdminOrders();
        filterOrders();
      } catch(error) {
        console.error('Error updating order:', error);
        alert('Failed to update order. Please try again.');
      }
    }

    function updateEditTotal() {
      const DELIVERY_FEE = 10;
      let total = 0;
      
      for (let i = 0; i < window.editOrderData.items.length; i++) {
        const qtyInput = document.getElementById(`editQty_${i}`);
        if (qtyInput && qtyInput.parentElement.parentElement.parentElement) {
          const qty = parseInt(qtyInput.value) || 0;
          const item = window.editOrderData.items[i];
          total += Number(item.price) * qty;
        }
      }
      
      total += DELIVERY_FEE;
      document.getElementById('editTotal').textContent = total.toFixed(2);
    }

    function removeEditItem(idx) {
      window.editOrderData.items.splice(idx, 1);
      document.getElementById('editOrderModal').remove();
      editOrder(window.editOrderData.orderId);
    }

    async function addEditItem() {
      // Fetch menu items
      try {
        const response = await fetch('/menu');
        const menuItems = await response.json();
        
        if (menuItems.length === 0) {
          alert('No menu items available.');
          return;
        }
        
        // Create a simple selection dialog
        const itemNames = menuItems.map(item => item.name).join('\n');
        const selectedName = prompt(`Enter item name to add:\n\nAvailable items:\n${itemNames}`);
        if (!selectedName) return;
        
        const selectedItem = menuItems.find(item => 
          item.name.toLowerCase() === selectedName.toLowerCase()
        );
        
        if (!selectedItem) {
          alert('Item not found. Please enter the exact item name.');
          return;
        }
        
        if (selectedItem.is_available === false || (selectedItem.quantity || 0) === 0) {
          alert('This item is currently out of stock.');
          return;
        }
        
        const qty = parseInt(prompt(`Enter quantity for ${selectedItem.name}:`, '1')) || 1;
        if (qty <= 0) {
          alert('Quantity must be greater than 0.');
          return;
        }
        
        window.editOrderData.items.push({
          id: selectedItem.id,
          name: selectedItem.name,
          price: selectedItem.price,
          qty: qty
        });
        
        // Refresh the modal
        document.getElementById('editOrderModal').remove();
        editOrder(window.editOrderData.orderId);
      } catch(error) {
        console.error('Error adding item:', error);
        alert('Failed to load menu items.');
      }
    }

    /* -------- Print Functions -------- */
    function printOrders() {
      if (filteredOrders.length === 0) {
        alert('No orders to print');
        return;
      }
      window.print();
    }

    function printSingleOrder(orderId) {
      // Get sequential order number
      const orderNumberMap = getOrderNumberMap();
      const sequentialNumber = orderNumberMap[orderId] || orderId;
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      
      const buyerName = order.fullname || order.name || "N/A";
      const buyerContact = order.contact || order.number || "N/A";
      const buyerAddress = order.location || order.address || "N/A";
      const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Order #${sequentialNumber} - RMLCanteen</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #8B4513; }
            .info { margin: 10px 0; }
            .items { margin: 20px 0; border-top: 2px solid #ccc; padding-top: 10px; }
            .total { font-size: 1.2em; font-weight: bold; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>üçΩÔ∏è RMLCanteen - Order Receipt</h1>
          <div class="info"><strong>Order #:</strong> ${sequentialNumber}</div>
          <div class="info"><strong>Date:</strong> ${new Date(order.created_at || Date.now()).toLocaleString()}</div>
          <div class="info"><strong>Status:</strong> ${order.status}</div>
          <hr>
          <h3>Customer Information</h3>
          <div class="info"><strong>Name:</strong> ${buyerName}</div>
          <div class="info"><strong>Contact:</strong> ${buyerContact}</div>
          <div class="info"><strong>Address:</strong> ${buyerAddress}</div>
          <div class="items">
            <h3>Order Items</h3>
            ${items.map(it => `<div>‚Ä¢ ${it.name} √ó ${it.qty} - ‚Ç±${(Number(it.price) * Number(it.qty)).toFixed(2)}</div>`).join('')}
          </div>
          <div class="total">Total Amount: ‚Ç±${Number(order.total).toFixed(2)}</div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    /* -------- Menu Management Functions -------- */
    async function renderAdminMenuList() {
      try {
        const response = await fetch('/menu');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const menuItems = await response.json();
        
        // Ensure menuItems is an array
        if (!Array.isArray(menuItems)) {
          console.error('Menu items is not an array:', menuItems);
          document.getElementById('adminMenuList').innerHTML = '<p class="muted">No menu items available. Add your first item below.</p>';
          return;
        }
        
        const menuArea = document.getElementById('adminMenuList');
        if (!menuArea) return;

        // Group by category
        const grouped = {
          budget: [],
          foods: [],
          drinks: []
        };
        
        menuItems.forEach(item => {
          const category = item.category || 'foods';
          if (grouped[category]) {
            grouped[category].push(item);
          }
        });

        menuArea.innerHTML = Object.keys(grouped).map(category => {
          const items = grouped[category];
          if (items.length === 0) return '';
          
          const categoryName = {
            budget: 'üçõ Budget Meals',
            foods: 'üçî Foods',
            drinks: 'ü•§ Drinks'
          }[category] || category;
          
          const itemsHtml = items.map(item => {
            const isAvailable = item.is_available !== false;
            const quantity = item.quantity || 0;
            const stockStatus = quantity > 0 ? `üì¶ ${quantity} in stock` : '‚ö†Ô∏è Out of Stock';
            const stockColor = quantity > 0 ? (quantity < 10 ? '#ff9800' : '#4caf50') : '#f44336';
            const stockBadgeStyle = `display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: ${stockColor}15; color: ${stockColor}; border: 1px solid ${stockColor}40; margin-top: 6px;`;
            return `
              <div class="item-row" style="border: 1px solid #eee; padding: 16px; margin-bottom: 12px; border-radius: 8px; background: ${isAvailable ? '#fff' : '#f5f5f5'}; display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
                <div style="flex: 1;">
                  <strong style="font-size: 1.1rem;">${item.name}</strong>
                  <div style="color: var(--muted); font-size: 0.95rem; margin: 4px 0;">‚Ç±${Number(item.price).toFixed(2)}</div>
                  <div style="${stockBadgeStyle}">${stockStatus}</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end; min-width: 200px;">
                  <div style="display: flex; gap: 6px; align-items: center; width: 100%;">
                    <input type="number" id="stock_${item.id}" value="${quantity}" min="0" 
                           style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 0.9rem;"
                           onkeypress="if(event.key==='Enter') updateStockQuantity(${item.id})">
                    <button class="btn small" onclick="updateStockQuantity(${item.id})" style="flex: 1;">Update Stock</button>
                  </div>
                  <div style="display: flex; gap: 6px; width: 100%;">
                    <button class="btn small ${isAvailable ? 'ghost' : ''}" onclick="toggleMenuItemAvailability(${item.id}, ${!isAvailable})" style="flex: 1;">
                      ${isAvailable ? 'Mark Sold Out' : 'Mark Available'}
                    </button>
                    <button class="btn small" onclick="editMenuItem(${item.id}, '${item.name}', ${item.price}, '${item.category}', ${quantity})" style="flex: 1;">Edit</button>
                    <button class="btn delete small" onclick="deleteMenuItem(${item.id})" style="flex: 1;">Delete</button>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          return `
            <div class="card" style="margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0;">${categoryName}</h4>
              ${itemsHtml}
            </div>
          `;
        }).join('');
      } catch(error) {
        console.error('Error loading menu:', error);
        document.getElementById('adminMenuList').innerHTML = '<p class="muted">Failed to load menu items</p>';
      }
    }

    async function addMenuItem() {
      const name = document.getElementById('newItemName')?.value.trim();
      const price = parseFloat(document.getElementById('newItemPrice')?.value);
      const category = document.getElementById('newItemCategory')?.value || 'foods';
      const quantity = parseInt(document.getElementById('newItemQuantity')?.value || '0') || 0;

      if (!name || !price || price <= 0) {
        return alert('Please enter a valid name and price.');
      }

      if (quantity < 0) {
        return alert('Stock quantity cannot be negative.');
      }

      try {
        const response = await fetch('/menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price, category, is_available: true, quantity })
        });

        // Read response
        let responseData = null;
        try {
          const responseText = await response.text();
          if (responseText) {
            responseData = JSON.parse(responseText);
          }
        } catch(parseError) {
          console.log('Response parse note:', parseError);
        }

        if (response.ok) {
          alert('‚úÖ Menu item added successfully!');
          document.getElementById('newItemName').value = '';
          document.getElementById('newItemPrice').value = '';
          document.getElementById('newItemQuantity').value = '0';
          await renderAdminMenuList();
        } else {
          // Try to get error message
          let errorMessage = `Server returned ${response.status}: ${response.statusText}`;
          if (responseData) {
            if (responseData.detail) {
              errorMessage = responseData.detail;
            } else if (responseData.message) {
              errorMessage = responseData.message;
            } else if (typeof responseData === 'string') {
              errorMessage = responseData;
            }
          }
          console.error('Add menu item error:', {
            status: response.status,
            statusText: response.statusText,
            responseData: responseData,
            fullResponse: response
          });
          
          // Show detailed error
          let userMessage = `‚ùå Failed to add menu item:\n\n${errorMessage}`;
          if (responseData && responseData.detail) {
            userMessage += `\n\nDetails: ${responseData.detail}`;
          }
          userMessage += `\n\nPlease check:\n- Name and price are filled\n- Price is a valid number\n- Check Render logs for database errors`;
          alert(userMessage);
        }
      } catch(error) {
        console.error('Error adding menu item:', error);
        alert(`Failed to add menu item: ${error.message || 'Please check your connection and try again.'}`);
      }
    }

    async function editMenuItem(id, currentName, currentPrice, currentCategory, currentQuantity) {
      const name = prompt('Enter new name:', currentName);
      if (name === null) return;
      
      const priceStr = prompt('Enter new price:', currentPrice);
      if (priceStr === null) return;
      const price = parseFloat(priceStr);
      
      if (!name.trim() || !price || price <= 0) {
        return alert('Invalid name or price.');
      }

      const category = prompt('Enter category (budget/foods/drinks):', currentCategory);
      if (category === null) return;
      
      if (!['budget', 'foods', 'drinks'].includes(category)) {
        return alert('Invalid category. Must be: budget, foods, or drinks');
      }

      const quantityStr = prompt('Enter stock quantity:', currentQuantity || 0);
      if (quantityStr === null) return;
      const quantity = parseInt(quantityStr) || 0;
      
      if (quantity < 0) {
        return alert('Stock quantity cannot be negative.');
      }

      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name.trim(), price, category, quantity })
        });

        if (response.ok) {
          alert('‚úÖ Menu item updated successfully!');
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to update item: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error updating menu item:', error);
        alert('Failed to update menu item. Please try again.');
      }
    }

    async function toggleMenuItemAvailability(id, isAvailable) {
      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_available: isAvailable })
        });

        if (response.ok) {
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to update availability: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error updating availability:', error);
        alert('Failed to update availability. Please try again.');
      }
    }

    async function updateStockQuantity(id) {
      const input = document.getElementById(`stock_${id}`);
      if (!input) return;
      
      const quantity = parseInt(input.value) || 0;
      if (quantity < 0) {
        alert('Stock quantity cannot be negative.');
        input.focus();
        return;
      }

      try {
        // Update both quantity and availability in a single call
        const updateAvailability = quantity > 0;
        const response = await fetch(`/menu/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            quantity: quantity,
            is_available: updateAvailability 
          })
        });

        if (response.ok) {
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to update stock: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error updating stock:', error);
        alert('Failed to update stock. Please try again.');
      }
    }


    async function deleteMenuItem(id) {
      if (!confirm('‚ö†Ô∏è Are you sure you want to delete this menu item?\n\nThis action cannot be undone.')) return;

      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          alert('‚úÖ Menu item deleted successfully!');
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to delete item: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error deleting menu item:', error);
        alert('Failed to delete menu item. Please try again.');
      }
    }

    /* -------- User Management Functions -------- */
    async function renderAdminUsers() {
      try {
        const response = await fetch('/users');
        const users = await response.json();
        
        const usersArea = document.getElementById('usersList');
        if (!usersArea) return;

        // Separate users by approval status
        const pendingUsers = users.filter(u => (u.is_approved === false || u.is_approved === 0) && u.role !== 'admin');
        const approvedUsers = users.filter(u => (u.is_approved === true || u.is_approved === 1) && u.role !== 'admin');
        const adminUsers = users.filter(u => u.role === 'admin');

        // Update badge
        const badge = document.getElementById('usersBadge');
        if (badge) badge.textContent = pendingUsers.length;

        let html = '';

        // Pending Users Section
        if (pendingUsers.length > 0) {
          html += `
            <div class="card" style="margin-bottom: 20px; border-left: 4px solid #ff9800;">
              <h3 style="margin: 0 0 16px 0; color: #ff9800;">‚è≥ Pending Approval (${pendingUsers.length})</h3>
              ${pendingUsers.map(user => {
                const isApproved = user.is_approved === true || user.is_approved === 1;
                return `
                  <div class="item-row" style="border: 1px solid #eee; padding: 16px; margin-bottom: 12px; border-radius: 8px; background: #fff8f1;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
                      <div style="flex: 1;">
                        <strong style="font-size: 1.1rem;">${user.name || 'N/A'}</strong>
                        <div style="color: var(--muted); font-size: 0.95rem; margin: 4px 0;">${user.email || 'N/A'}</div>
                        <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;" class="proof-comparison-grid">
                          ${user.id_proof ? `
                          <div>
                            <strong>üì∑ ID Proof:</strong>
                            <div style="margin-top: 8px;">
                              <img src="${user.id_proof}" alt="ID Proof" 
                                   class="user-id-proof-thumbnail"
                                   style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #8b4513; cursor: pointer;"
                                   data-user-id="${user.id}"
                                   data-proof-type="id">
                            </div>
                            <p style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">
                              Click to view full size
                            </p>
                          </div>
                          ` : '<div><div style="color: #f44336; font-size: 0.9rem;">‚ö†Ô∏è No ID Proof</div></div>'}
                          ${user.selfie_proof ? `
                          <div>
                            <strong>ü§≥ Selfie Proof:</strong>
                            <div style="margin-top: 8px;">
                              <img src="${user.selfie_proof}" alt="Selfie Proof" 
                                   class="user-selfie-proof-thumbnail"
                                   style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #2196F3; cursor: pointer;"
                                   data-user-id="${user.id}"
                                   data-proof-type="selfie">
                            </div>
                            <p style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">
                              Click to view full size
                            </p>
                          </div>
                          ` : '<div><div style="color: #f44336; font-size: 0.9rem;">‚ö†Ô∏è No Selfie Proof</div></div>'}
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 6px; font-size: 0.85rem; color: #1976d2;">
                          üí° <strong>Compare:</strong> Verify that the ID and selfie belong to the same person
                        </div>
                      </div>
                      <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end; min-width: 200px;">
                        <select id="roleSelect_${user.id}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 6px;">
                          <option value="user">üë§ User</option>
                          <option value="admin">üëë Admin</option>
                        </select>
                        <div style="display: flex; gap: 8px; width: 100%;">
                          <button class="btn small" onclick="approveUserWithRole(${user.id}, true)" style="background: #4caf50; color: white; flex: 1;">‚úÖ Approve</button>
                          <button class="btn delete small" onclick="approveUser(${user.id}, false)" style="flex: 1;">‚ùå Reject</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        } else {
          html += `
            <div class="card" style="margin-bottom: 20px; text-align: center; padding: 40px; color: var(--muted);">
              ‚úÖ No pending user approvals
            </div>
          `;
        }

        // Approved Users Section
        if (approvedUsers.length > 0) {
          html += `
            <div class="card" style="margin-bottom: 20px;">
              <h3 style="margin: 0 0 16px 0;">‚úÖ Approved Users (${approvedUsers.length})</h3>
              ${approvedUsers.map(user => `
                <div class="item-row" style="border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 8px; background: #f5f5f5;">
                  <div style="flex: 1;">
                    <strong>${user.name || 'N/A'}</strong>
                    <div style="color: var(--muted); font-size: 0.9rem;">${user.email || 'N/A'}</div>
                  </div>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="padding: 4px 12px; background: #4caf50; color: white; border-radius: 12px; font-size: 0.85rem;">‚úÖ Approved</span>
                    <span style="padding: 4px 12px; background: ${user.role === 'admin' ? '#2196F3' : '#666'}; color: white; border-radius: 12px; font-size: 0.85rem;">
                      ${user.role === 'admin' ? 'üëë Admin' : 'üë§ User'}
                    </span>
                    <button class="btn delete small" onclick="approveUser(${user.id}, false)">Revoke</button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        usersArea.innerHTML = html;

        // Set up ID proof and selfie proof image click handlers
        document.querySelectorAll('.user-id-proof-thumbnail, .user-selfie-proof-thumbnail').forEach(img => {
          img.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const proofType = this.dataset.proofType;
            const user = users.find(u => u.id == userId);
            if (user) {
              if (proofType === 'id' && user.id_proof) {
                showUserProofModal(user.id_proof, user.name, 'ID Proof');
              } else if (proofType === 'selfie' && user.selfie_proof) {
                showUserProofModal(user.selfie_proof, user.name, 'Selfie Proof');
              }
            }
          });
        });
      } catch(error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<p class="muted">Failed to load users</p>';
      }
    }

    async function approveUserWithRole(userId, isApproved) {
      const roleSelect = document.getElementById(`roleSelect_${userId}`);
      const selectedRole = roleSelect ? roleSelect.value : 'user';
      
      const action = isApproved ? 'approve' : 'reject';
      const roleText = selectedRole === 'admin' ? ' as Admin' : ' as User';
      if (!confirm(`Are you sure you want to ${action} this user${roleText}?`)) return;

      try {
        const response = await fetch(`/users/${userId}/approve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            is_approved: isApproved,
            role: selectedRole
          })
        });

        if (response.ok) {
          const roleMsg = selectedRole === 'admin' ? ' as Admin' : ' as User';
          alert(`‚úÖ User ${isApproved ? 'approved' : 'rejected'}${roleMsg} successfully!`);
          await renderAdminUsers();
        } else {
          const errorData = await response.json();
          alert(`Failed to ${action} user: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error(`Error ${action}ing user:`, error);
        alert(`Failed to ${action} user. Please try again.`);
      }
    }

    async function approveUser(userId, isApproved) {
      const action = isApproved ? 'approve' : 'reject';
      if (!confirm(`Are you sure you want to ${action} this user?`)) return;

      try {
        const response = await fetch(`/users/${userId}/approve`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_approved: isApproved })
        });

        if (response.ok) {
          const result = await response.json();
          if (result.deleted) {
            alert(`‚úÖ User rejected and removed successfully!`);
          } else {
            alert(`‚úÖ User ${isApproved ? 'approved' : 'rejected'} successfully!`);
          }
          await renderAdminUsers();
        } else {
          const errorData = await response.json();
          alert(`Failed to ${action} user: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error(`Error ${action}ing user:`, error);
        alert(`Failed to ${action} user. Please try again.`);
      }
    }

    function showUserProofModal(imageSrc, userName, proofType) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      const borderColor = proofType === 'ID Proof' ? '#8b4513' : '#2196F3';
      const icon = proofType === 'ID Proof' ? 'üì∑' : 'ü§≥';
      
      modal.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 90%; background: white; border-radius: 12px; padding: 20px;">
          <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                  style="position: absolute; top: 10px; right: 10px; background: ${borderColor}; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; font-weight: bold;">√ó</button>
          <h3 style="margin: 0 0 16px 0; color: ${borderColor};">${icon} ${proofType} - ${userName}</h3>
          <img src="${imageSrc}" alt="${proofType}" style="max-width: 100%; max-height: 70vh; border-radius: 8px; border: 2px solid ${borderColor};">
          <p style="margin-top: 12px; font-size: 0.9rem; color: #666; text-align: center;">Click outside or press √ó to close</p>
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      document.body.appendChild(modal);
    }

    /* -------- Real-time Order Notifications -------- */
    let lastOrderId = 0;
    let orderPollInterval = null;
    let notificationSound = null;

    // Create notification sound (optional)
    function createNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch(e) {
        console.log('Could not play notification sound:', e);
      }
    }

    // Show notification
    function showOrderNotification(order) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;

      const notification = document.createElement('div');
      notification.className = 'order-notification';
      notification.style.cssText = `
        background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease-out;
        cursor: pointer;
        border-left: 4px solid #FFD700;
      `;

      const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
      const itemCount = items.reduce((sum, item) => sum + (item.qty || 1), 0);
      const total = parseFloat(order.total || 0).toFixed(2);

      // Get sequential order number for notification
      const orderNumberMap = getOrderNumberMap();
      const sequentialNumber = orderNumberMap[order.id] || order.id;
      
      notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
          <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
              üîî New Order #${sequentialNumber}
            </div>
            <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 4px;">
              <strong>${order.fullname || order.name || 'Customer'}</strong>
            </div>
            <div style="font-size: 0.85rem; opacity: 0.85;">
              ${itemCount} item${itemCount !== 1 ? 's' : ''} ‚Ä¢ ‚Ç±${total}
            </div>
            <div style="font-size: 0.8rem; opacity: 0.75; margin-top: 4px;">
              ${order.location || order.address || 'No address'}
            </div>
          </div>
          <button onclick="this.parentElement.parentElement.remove(); switchTab('orders');" 
                  style="background: rgba(255,255,255,0.2); border: none; color: white; 
                         width: 28px; height: 28px; border-radius: 50%; cursor: pointer; 
                         font-size: 18px; line-height: 1; padding: 0;">√ó</button>
        </div>
      `;

      // Click to view order
      notification.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
          switchTab('orders');
          // Scroll to the order
          setTimeout(() => {
            const orderCard = document.querySelector(`[data-order-id="${order.id}"]`);
            if (orderCard) {
              orderCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
              orderCard.style.animation = 'pulse 1s ease-in-out';
              setTimeout(() => {
                orderCard.style.animation = '';
              }, 1000);
            }
          }, 100);
          notification.remove();
        }
      });

      container.appendChild(notification);

      // Play sound
      createNotificationSound();

      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        }
      }, 10000);
    }

    // Check for new orders
    async function checkForNewOrders() {
      try {
        const response = await fetch('/orders');
        if (!response.ok) return;
        
        const orders = await response.json();
        if (!Array.isArray(orders) || orders.length === 0) return;

        // Get the latest order ID
        const latestOrderId = orders[0]?.id || 0;
        const previousLastOrderId = lastOrderId;

        // If we have a new order (ID greater than last known)
        if (latestOrderId > lastOrderId && lastOrderId > 0) {
          // Find all new orders
          const newOrders = orders.filter(o => o.id > lastOrderId);
          
          // Show notification for each new order (most recent first)
          newOrders.reverse().forEach(order => {
            showOrderNotification(order);
          });

          // Update badge count
          const pendingCount = orders.filter(o => o.status === 'Pending').length;
          const badge = document.getElementById('ordersBadge');
          if (badge) {
            badge.textContent = pendingCount;
            if (pendingCount > 0) {
              badge.style.animation = 'pulse 0.5s ease-in-out 3';
            }
          }
        }

        // Update last known order ID
        if (latestOrderId > lastOrderId) {
          lastOrderId = latestOrderId;
        }

        // Check if any orders changed status (for real-time number updates)
        const currentOrders = orders.reverse();
        const ordersChanged = JSON.stringify(currentOrders.map(o => ({id: o.id, status: o.status}))) !== 
                              JSON.stringify(allOrders.map(o => ({id: o.id, status: o.status})));
        
        // If orders changed or we're on the orders tab, refresh the display
        if (ordersChanged || document.getElementById('ordersSection').classList.contains('active')) {
          allOrders = currentOrders;
          filteredOrders = [...allOrders];
          displayOrders(); // This will update sequential numbers
          renderStats();
        } else {
          // Just update stats if not on orders tab
          renderStats();
        }
      } catch(error) {
        console.error('Error checking for new orders:', error);
      }
    }

    // Start polling for new orders
    function startOrderPolling() {
      // Initial load - set lastOrderId
      renderAdminOrders().then(() => {
        if (allOrders && allOrders.length > 0) {
          lastOrderId = allOrders[0].id || 0;
        }
      });

      // Poll every 5 seconds
      orderPollInterval = setInterval(checkForNewOrders, 5000);
    }

    // Stop polling
    function stopOrderPolling() {
      if (orderPollInterval) {
        clearInterval(orderPollInterval);
        orderPollInterval = null;
      }
    }

    /* -------- Initialize -------- */

    window.addEventListener('DOMContentLoaded', () => {
      ensureLoggedIn('admin');
      renderStats();
      renderAdminOrders();
      renderAdminMenuList(); // Load menu items on page load
      
      // Start real-time order notifications
      startOrderPolling();
    });

    // Stop polling when page is hidden (save resources)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopOrderPolling();
      } else {
        startOrderPolling();
      }
    });
  </script>
</body>
</html>
