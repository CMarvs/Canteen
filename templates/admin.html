<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard â€” RMLCanteen</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/admin.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">ğŸ½ï¸ RMLCanteen Admin</div>
    <nav class="nav">
      <a href="#" onclick="logoutUser()">ğŸšª Logout</a>
    </nav>
  </header>

  <main>
    <!-- Statistics Dashboard -->
    <div class="stats-grid" id="statsGrid"></div>

    <div class="content-card">
      <div class="tab-buttons">
        <button id="tabOrders" class="active" onclick="switchTab('orders')">
          ğŸ“¦ Orders <span class="tab-badge" id="ordersBadge">0</span>
        </button>
        <button id="tabMenu" onclick="switchTab('menu')">
          ğŸ½ï¸ Menu Management
        </button>
      </div>

      <!-- ORDER STATUS UPDATE TAB -->
      <section id="ordersSection" class="tab-content active">
        <h2>ğŸ“¦ Order Management</h2>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="ğŸ” Search by name, contact, or order ID..." 
            oninput="filterOrders()"
          >
        </div>

        <div id="ordersList"></div>
      </section>

      <!-- MENU TAB -->
      <section id="menuSection" class="tab-content">
        <h2>ğŸ½ï¸ Menu Management</h2>
        <p style="color: var(--text); margin-bottom: 20px;">
          Add, edit, or remove menu items. Control what items are available for customers.
        </p>
        
        <!-- Add New Item Form -->
        <div class="card" style="margin-bottom: 20px; background: #fff8f1;">
          <h3 style="margin-top: 0;">â• Add New Menu Item</h3>
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
            <div>
              <label class="input-label">Item Name</label>
              <input type="text" id="newItemName" placeholder="e.g., Chicken Adobo" style="width: 100%;">
            </div>
            <div>
              <label class="input-label">Price (â‚±)</label>
              <input type="number" id="newItemPrice" placeholder="50" min="0" step="0.01" style="width: 100%;">
            </div>
            <div>
              <label class="input-label">Category</label>
              <select id="newItemCategory" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="budget">Budget Meals</option>
                <option value="foods">Foods</option>
                <option value="drinks">Drinks</option>
              </select>
            </div>
            <button class="btn" onclick="addMenuItem()" style="height: fit-content;">Add Item</button>
          </div>
        </div>
        
        <div id="adminMenuList"></div>
      </section>
    </div>
  </main>

  <script src="/static/script.js"></script>
  <script>
    // Global state for filtering
    let allOrders = [];
    let filteredOrders = [];

    /* -------- Statistics Dashboard -------- */
    async function renderStats() {
      const orders = allOrders;
      const stats = {
        total: orders.length,
        pending: orders.filter(o => o.status === 'Pending').length,
        preparing: orders.filter(o => o.status === 'Preparing').length,
        delivery: orders.filter(o => o.status === 'Out for Delivery').length,
        delivered: orders.filter(o => o.status === 'Delivered').length,
        revenue: orders.reduce((sum, o) => sum + Number(o.total || 0), 0)
      };

      const statsGrid = document.getElementById('statsGrid');
      if (!statsGrid) return;

      statsGrid.innerHTML = `
        <div class="stat-card total">
          <div class="stat-label">ğŸ“Š Total Orders</div>
          <div class="stat-number">${stats.total}</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-label">â³ Pending</div>
          <div class="stat-number">${stats.pending}</div>
        </div>
        <div class="stat-card preparing">
          <div class="stat-label">ğŸ‘¨â€ğŸ³ Preparing</div>
          <div class="stat-number">${stats.preparing}</div>
        </div>
        <div class="stat-card delivery">
          <div class="stat-label">ğŸšš Out for Delivery</div>
          <div class="stat-number">${stats.delivery}</div>
        </div>
        <div class="stat-card delivered">
          <div class="stat-label">âœ… Delivered</div>
          <div class="stat-number">${stats.delivered}</div>
        </div>
        <div class="stat-card total">
          <div class="stat-label">ğŸ’° Total Revenue</div>
          <div class="stat-number">â‚±${stats.revenue.toFixed(2)}</div>
        </div>
      `;

      // Update badge
      const badge = document.getElementById('ordersBadge');
      if (badge) badge.textContent = stats.total;
    }

    /* -------- Tab Switching -------- */
    function switchTab(tab) {
      document.getElementById('tabOrders').classList.remove('active');
      document.getElementById('tabMenu').classList.remove('active');
      document.getElementById('ordersSection').classList.remove('active');
      document.getElementById('menuSection').classList.remove('active');

      if (tab === 'orders') {
        document.getElementById('tabOrders').classList.add('active');
        document.getElementById('ordersSection').classList.add('active');
        renderAdminOrders();
      } else {
        document.getElementById('tabMenu').classList.add('active');
        document.getElementById('menuSection').classList.add('active');
        renderAdminMenuList();
      }
    }

    /* -------- Render Orders (API) -------- */
    async function renderAdminOrders() {
      try {
        const response = await fetch('/orders');
        const orders = await response.json();
        allOrders = orders.reverse();
        filteredOrders = [...allOrders];
        renderStats();
        displayOrders();
      } catch(error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = '<p class="muted">Failed to load orders</p>';
      }
    }

    function displayOrders() {
      const container = document.getElementById('ordersList');
      if (!container) return;

      if (filteredOrders.length === 0) {
        const hasFilters = document.getElementById('searchInput')?.value || 
                          document.getElementById('statusFilter')?.value !== 'all';
        if (hasFilters) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ”</div>
              <div class="empty-state-text">No orders match your search criteria</div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“¦</div>
              <div class="empty-state-text">No orders yet</div>
            </div>
          `;
        }
        return;
      }

      container.innerHTML = filteredOrders.map((o, displayIdx) => {
        const actualIdx = allOrders.indexOf(o);
        let badgeClass = "";
        switch (o.status) {
          case "Pending": badgeClass = "status-pending"; break;
          case "Preparing": badgeClass = "status-preparing"; break;
          case "Out for Delivery": badgeClass = "status-delivery"; break;
          case "Delivered": badgeClass = "status-delivered"; break;
          default: badgeClass = "status-pending";
        }

        const buyerName = o.fullname || o.name || "N/A";
        const buyerContact = o.contact || o.number || "N/A";
        const buyerAddress = o.location || o.address || "N/A";
        const orderDate = new Date(o.created_at || Date.now()).toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Parse items if it's a string (from database)
        const items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;

        return `
          <div class="order-card" data-order-id="${o.id}">
            <div class="order-header">
              <div>
                <div class="order-id">Order #${o.id}</div>
                <div class="order-date">${orderDate}</div>
              </div>
              <span class="status-badge ${badgeClass}">${o.status}</span>
            </div>

            <div class="buyer-info">
              <p><strong>ğŸ‘¤ Customer:</strong> ${buyerName}</p>
              <p><strong>ğŸ“ Contact:</strong> ${buyerContact}</p>
              <p><strong>ğŸ“ Address:</strong> ${buyerAddress}</p>
            </div>

            ${o.id_proof ? `
            <div class="id-proof-section" style="margin: 12px 0; padding: 12px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">
              <strong>ğŸ“· ID Proof:</strong>
              <div style="margin-top: 8px;">
                <img src="${o.id_proof}" alt="ID Proof" 
                     class="id-proof-thumbnail"
                     style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #8b4513; cursor: pointer;"
                     data-order-id="${o.id}">
              </div>
              <p style="font-size: 0.85rem; color: var(--muted); margin-top: 8px;">
                Click image to view full size
              </p>
            </div>
            ` : `
            <div class="id-proof-section" style="margin: 12px 0; padding: 12px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
              <strong>âš ï¸ No ID Proof:</strong> Customer did not provide ID verification
            </div>
            `}

            <div class="order-items">
              <strong>ğŸ“‹ Items:</strong><br>
              ${items.map(it => `â€¢ ${it.name} Ã— ${it.qty} (â‚±${(Number(it.price) * Number(it.qty)).toFixed(2)})`).join('<br>')}
            </div>

            <div class="order-total">
              ğŸ’° Total: â‚±${Number(o.total).toFixed(2)}
            </div>

            <div class="status-buttons">
              <select class="status-select" onchange="updateOrderStatus(${o.id}, this.value)" value="${o.status || 'Pending'}">
                <option value="Pending" ${(!o.status || o.status === 'Pending') ? 'selected' : ''}>â³ Pending</option>
                <option value="Preparing" ${o.status === 'Preparing' ? 'selected' : ''}>ğŸ‘¨â€ğŸ³ Preparing</option>
                <option value="Out for Delivery" ${o.status === 'Out for Delivery' ? 'selected' : ''}>ğŸšš Out for Delivery</option>
                <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>âœ… Delivered</option>
              </select>
              <button class="btn small print" onclick="printSingleOrder(${o.id})">ğŸ–¨ï¸ Print</button>
              <button class="btn delete small" onclick="deleteOrder(${o.id})">ğŸ—‘ï¸ Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    /* -------- Filter Orders -------- */
    function filterOrders() {
      const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

      filteredOrders = allOrders.filter(o => {
        const buyerName = (o.fullname || o.name || '').toLowerCase();
        const buyerContact = (o.contact || o.number || '').toLowerCase();
        const orderId = (o.id || '').toLowerCase();
        
        const matchesSearch = !searchTerm || 
          buyerName.includes(searchTerm) || 
          buyerContact.includes(searchTerm) ||
          orderId.includes(searchTerm);

        return matchesSearch;
      });

      displayOrders();
    }

    /* -------- Update Status (API) -------- */
    async function updateOrderStatus(orderId, status) {
      if (!status) {
        // Invalid selection, reset
        await renderAdminOrders();
        return;
      }
      
      let response;
      try {
        response = await fetch(`/orders/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });
      } catch(networkError) {
        // Network/connection error
        console.error('Network error updating order:', networkError);
        alert('Failed to update order status. Please check your connection and try again.');
        await renderAdminOrders();
        return;
      }

      // Check if response is successful
      if (!response.ok) {
        // Handle error response
        let errorMessage = `Server returned ${response.status}: ${response.statusText}`;
        try {
          const errorData = await response.json();
          errorMessage = errorData.detail || errorMessage;
        } catch(e) {
          // If we can't parse error, use status text
          console.log('Could not parse error response:', e);
        }
        alert(`Failed to update order status: ${errorMessage}`);
        await renderAdminOrders();
        return;
      }

      // Success - consume response body (ignore parsing errors)
      try {
        await response.json();
      } catch(e) {
        // Response parsing failed, but status was OK - that's fine
        // This can happen if response is empty or malformed, but update succeeded
        console.log('Response body note (update succeeded):', e);
      }

      // Success - update the UI silently
      await renderAdminOrders();
      filterOrders();
    }

    /* -------- Delete Order -------- */
    async function deleteOrder(orderId) {
      if (!confirm(`âš ï¸ Are you sure you want to delete Order #${orderId}?\n\nThis action cannot be undone.`)) return;
      
      try {
        const response = await fetch(`/orders/${orderId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        // Read response once
        let responseData = null;
        try {
          const responseText = await response.text();
          if (responseText) {
            responseData = JSON.parse(responseText);
          }
        } catch(parseError) {
          // If parsing fails, that's okay - we'll check status code
          console.log('Response parse note:', parseError);
        }

        if (!response.ok) {
          // Handle error response
          const errorMessage = responseData?.detail || `Server returned ${response.status}: ${response.statusText}`;
          alert(`Failed to delete order: ${errorMessage}`);
          return;
        }

        // Success - show message and refresh
        alert('âœ… Order deleted successfully!');
        
        // Refresh orders list (wrap in try-catch to prevent errors from showing to user)
        try {
          await renderAdminOrders();
          filterOrders();
        } catch(refreshError) {
          console.error('Error refreshing orders after delete:', refreshError);
          // Don't show error to user - deletion was successful, just refresh failed
        }
      } catch(error) {
        console.error('Error deleting order:', error);
        alert('Failed to delete order. Please check your connection and try again.');
      }
    }

    /* -------- Print Functions -------- */
    function printOrders() {
      if (filteredOrders.length === 0) {
        alert('No orders to print');
        return;
      }
      window.print();
    }

    function printSingleOrder(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;
      
      const buyerName = order.fullname || order.name || "N/A";
      const buyerContact = order.contact || order.number || "N/A";
      const buyerAddress = order.location || order.address || "N/A";
      const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Order #${order.id} - RMLCanteen</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #8B4513; }
            .info { margin: 10px 0; }
            .items { margin: 20px 0; border-top: 2px solid #ccc; padding-top: 10px; }
            .total { font-size: 1.2em; font-weight: bold; margin-top: 20px; }
          </style>
        </head>
        <body>
          <h1>ğŸ½ï¸ RMLCanteen - Order Receipt</h1>
          <div class="info"><strong>Order #:</strong> ${order.id}</div>
          <div class="info"><strong>Date:</strong> ${new Date(order.created_at || Date.now()).toLocaleString()}</div>
          <div class="info"><strong>Status:</strong> ${order.status}</div>
          <hr>
          <h3>Customer Information</h3>
          <div class="info"><strong>Name:</strong> ${buyerName}</div>
          <div class="info"><strong>Contact:</strong> ${buyerContact}</div>
          <div class="info"><strong>Address:</strong> ${buyerAddress}</div>
          <div class="items">
            <h3>Order Items</h3>
            ${items.map(it => `<div>â€¢ ${it.name} Ã— ${it.qty} - â‚±${(Number(it.price) * Number(it.qty)).toFixed(2)}</div>`).join('')}
          </div>
          <div class="total">Total Amount: â‚±${Number(order.total).toFixed(2)}</div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    /* -------- Menu Management Functions -------- */
    async function renderAdminMenuList() {
      try {
        const response = await fetch('/menu');
        const menuItems = await response.json();
        
        const menuArea = document.getElementById('adminMenuList');
        if (!menuArea) return;

        // Group by category
        const grouped = {
          budget: [],
          foods: [],
          drinks: []
        };
        
        menuItems.forEach(item => {
          const category = item.category || 'foods';
          if (grouped[category]) {
            grouped[category].push(item);
          }
        });

        menuArea.innerHTML = Object.keys(grouped).map(category => {
          const items = grouped[category];
          if (items.length === 0) return '';
          
          const categoryName = {
            budget: 'ğŸ› Budget Meals',
            foods: 'ğŸ” Foods',
            drinks: 'ğŸ¥¤ Drinks'
          }[category] || category;
          
          const itemsHtml = items.map(item => {
            const isAvailable = item.is_available !== false;
            return `
              <div class="item-row" style="border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 8px; background: ${isAvailable ? '#fff' : '#f5f5f5'};">
                <div style="flex: 1;">
                  <strong>${item.name}</strong>
                  <div style="color: var(--muted); font-size: 0.9rem;">â‚±${Number(item.price).toFixed(2)}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn small ${isAvailable ? 'ghost' : ''}" onclick="toggleMenuItemAvailability(${item.id}, ${!isAvailable})">
                    ${isAvailable ? 'Mark Sold Out' : 'Mark Available'}
                  </button>
                  <button class="btn small" onclick="editMenuItem(${item.id}, '${item.name}', ${item.price}, '${item.category}')">Edit</button>
                  <button class="btn delete small" onclick="deleteMenuItem(${item.id})">Delete</button>
                </div>
              </div>
            `;
          }).join('');
          
          return `
            <div class="card" style="margin-bottom: 16px;">
              <h4 style="margin: 0 0 12px 0;">${categoryName}</h4>
              ${itemsHtml}
            </div>
          `;
        }).join('');
      } catch(error) {
        console.error('Error loading menu:', error);
        document.getElementById('adminMenuList').innerHTML = '<p class="muted">Failed to load menu items</p>';
      }
    }

    async function addMenuItem() {
      const name = document.getElementById('newItemName')?.value.trim();
      const price = parseFloat(document.getElementById('newItemPrice')?.value);
      const category = document.getElementById('newItemCategory')?.value || 'foods';

      if (!name || !price || price <= 0) {
        return alert('Please enter a valid name and price.');
      }

      try {
        const response = await fetch('/menu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price, category, is_available: true })
        });

        // Read response
        let responseData = null;
        try {
          const responseText = await response.text();
          if (responseText) {
            responseData = JSON.parse(responseText);
          }
        } catch(parseError) {
          console.log('Response parse note:', parseError);
        }

        if (response.ok) {
          alert('âœ… Menu item added successfully!');
          document.getElementById('newItemName').value = '';
          document.getElementById('newItemPrice').value = '';
          await renderAdminMenuList();
        } else {
          // Try to get error message
          let errorMessage = `Server returned ${response.status}: ${response.statusText}`;
          if (responseData) {
            if (responseData.detail) {
              errorMessage = responseData.detail;
            } else if (responseData.message) {
              errorMessage = responseData.message;
            } else if (typeof responseData === 'string') {
              errorMessage = responseData;
            }
          }
          console.error('Add menu item error:', {
            status: response.status,
            statusText: response.statusText,
            responseData: responseData
          });
          alert(`Failed to add item: ${errorMessage}\n\nStatus: ${response.status}`);
        }
      } catch(error) {
        console.error('Error adding menu item:', error);
        alert(`Failed to add menu item: ${error.message || 'Please check your connection and try again.'}`);
      }
    }

    async function editMenuItem(id, currentName, currentPrice, currentCategory) {
      const name = prompt('Enter new name:', currentName);
      if (name === null) return;
      
      const priceStr = prompt('Enter new price:', currentPrice);
      if (priceStr === null) return;
      const price = parseFloat(priceStr);
      
      if (!name.trim() || !price || price <= 0) {
        return alert('Invalid name or price.');
      }

      const category = prompt('Enter category (budget/foods/drinks):', currentCategory);
      if (category === null) return;
      
      if (!['budget', 'foods', 'drinks'].includes(category)) {
        return alert('Invalid category. Must be: budget, foods, or drinks');
      }

      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name.trim(), price, category })
        });

        if (response.ok) {
          alert('âœ… Menu item updated successfully!');
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to update item: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error updating menu item:', error);
        alert('Failed to update menu item. Please try again.');
      }
    }

    async function toggleMenuItemAvailability(id, isAvailable) {
      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ is_available: isAvailable })
        });

        if (response.ok) {
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to update availability: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error updating availability:', error);
        alert('Failed to update availability. Please try again.');
      }
    }

    function showIdProofModal(imageSrc, customerName) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      modal.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 90%; background: white; border-radius: 12px; padding: 20px;">
          <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                  style="position: absolute; top: 10px; right: 10px; background: #8b4513; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; font-weight: bold;">Ã—</button>
          <h3 style="margin: 0 0 16px 0; color: #8b4513;">ID Proof - ${customerName}</h3>
          <img src="${imageSrc}" alt="ID Proof" style="max-width: 100%; max-height: 70vh; border-radius: 8px; border: 2px solid #8b4513;">
          <p style="margin-top: 12px; font-size: 0.9rem; color: #666; text-align: center;">Click outside or press Ã— to close</p>
        </div>
      `;
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      // Close on Escape key
      const closeOnEscape = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', closeOnEscape);
        }
      };
      document.addEventListener('keydown', closeOnEscape);
      
      document.body.appendChild(modal);
    }

    async function deleteMenuItem(id) {
      if (!confirm('âš ï¸ Are you sure you want to delete this menu item?\n\nThis action cannot be undone.')) return;

      try {
        const response = await fetch(`/menu/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          alert('âœ… Menu item deleted successfully!');
          await renderAdminMenuList();
        } else {
          const errorData = await response.json();
          alert(`Failed to delete item: ${errorData.detail || 'Unknown error'}`);
        }
      } catch(error) {
        console.error('Error deleting menu item:', error);
        alert('Failed to delete menu item. Please try again.');
      }
    }

    /* -------- Initialize -------- */
    // Set up event delegation for ID proof images
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('id-proof-thumbnail')) {
        const orderId = e.target.dataset.orderId;
        const order = allOrders.find(o => o.id == orderId);
        if (order && order.id_proof) {
          const buyerName = order.fullname || order.name || "Customer";
          showIdProofModal(order.id_proof, buyerName);
        }
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      ensureLoggedIn('admin');
      renderStats();
      renderAdminOrders();
      renderAdminMenuList(); // Load menu items on page load
    });
  </script>
</body>
</html>
