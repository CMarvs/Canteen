<!doctype html>
<!-- Version: 2.1 - Simplified Registration (No Proof Required) -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>RMLCanteen ‚Äî Register</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/auth.css">
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card card">
      <h2 class="headline center">üç¥ Create your Account</h2>

      <label class="input-label">Full name</label>
      <input id="regName" type="text" placeholder="Enter your full name">

      <label class="input-label">Email</label>
      <input id="regEmail" type="email" placeholder="you@example.com">

      <label class="input-label">Password</label>
      <div class="password-row">
        <input id="regPass" type="password" placeholder="Enter your password (min 4 chars)">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regPass', 'regPassToggle')" id="regPassToggle" title="Show password">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>

      <label class="input-label">Confirm Password</label>
      <div class="password-row">
        <input id="regConfirmPass" type="password" placeholder="Re-enter your password">
        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regConfirmPass', 'regConfirmPassToggle')" id="regConfirmPassToggle" title="Show password">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>

      <!-- Consent Checkboxes -->
      <div class="consent-section">
        <label class="consent-checkbox">
          <input type="checkbox" id="consentPromotions" required>
          <span class="checkmark"></span>
          <span class="consent-text">I would like to receive announcements and promotions from RML Canteen.</span>
        </label>

        <label class="consent-checkbox">
          <input type="checkbox" id="consentPrivacy" required>
          <span class="checkmark"></span>
          <span class="consent-text">I consent to the use and processing of my personal information for Customer Relationship Management purposes. I am aware of my data privacy rights including the option to withdraw my consent at any time.</span>
        </label>

        <label class="consent-checkbox">
          <input type="checkbox" id="consentTerms" required>
          <span class="checkmark"></span>
          <span class="consent-text">I have fully read, understood, and agree to the <a href="#" onclick="showTermsModal(); return false;" class="consent-link">Data Privacy Policy</a> and <a href="#" onclick="showTermsModal(); return false;" class="consent-link">Terms & Conditions</a> of RML Canteen.</span>
        </label>
      </div>

      <button class="btn btn-primary-large mt-8" onclick="registerUser()">Create your Account</button>
      <p class="center mt-4 muted" style="font-size: 0.85rem;" id="regMessage">
        ‚è≥ Your account will be reviewed by admin before you can login.
      </p>

      <p class="center mt-8 muted">
        Already registered? <a href="index.html" class="link">Login</a>
      </p>
    </div>
  </div>

  <!-- Terms Modal -->
  <div id="termsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal" onclick="closeTermsModal()">&times;</span>
      <h3>Terms & Conditions / Data Privacy Policy</h3>
      <div class="modal-body">
        <p><strong>Data Privacy Policy:</strong></p>
        <p>RML Canteen respects your privacy. We collect and process your personal information solely for the purpose of managing your account, processing orders, and providing customer service. Your data will not be shared with third parties without your consent.</p>
        <p>You have the right to access, correct, or delete your personal information at any time. You may withdraw your consent by contacting us.</p>
        <p><strong>Terms & Conditions:</strong></p>
        <p>By creating an account, you agree to use the service responsibly and in accordance with our policies. Orders are subject to availability and delivery terms. We reserve the right to suspend accounts that violate our terms of service.</p>
      </div>
    </div>
  </div>

  <script src="/static/script.js"></script>
  <script>
    function togglePasswordVisibility(inputId, buttonId){
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      if(input && button) {
        const svg = button.querySelector('svg');
        if(input.type === 'password') {
          input.type = 'text';
          button.title = 'Hide password';
          // Change to eye-slash icon
          if(svg) {
            svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
          }
        } else {
          input.type = 'password';
          button.title = 'Show password';
          // Change back to eye icon
          if(svg) {
            svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
          }
        }
      }
    }

    function showTermsModal() {
      const modal = document.getElementById('termsModal');
      if(modal) {
        modal.style.display = 'block';
      }
    }

    function closeTermsModal() {
      const modal = document.getElementById('termsModal');
      if(modal) {
        modal.style.display = 'none';
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('termsModal');
      if (event.target == modal) {
        closeTermsModal();
      }
    }

    // Check if this is first user on page load
    window.addEventListener('DOMContentLoaded', async function() {
      try {
        const checkResponse = await fetch('/users');
        const existingUsers = await checkResponse.json();
        if (existingUsers.length === 0) {
          const msgEl = document.getElementById('regMessage');
          if (msgEl) {
            msgEl.innerHTML = 'üëë You will be the first admin! No approval needed.';
            msgEl.style.color = '#4caf50';
          }
          // Make ID proof and selfie optional - update label text
          const labels = document.querySelectorAll('.input-label');
          labels.forEach(label => {
            if (label.textContent.includes('ID Proof')) {
              label.innerHTML = 'üì∑ ID Proof (Optional for first admin)';
            }
            if (label.textContent.includes('Selfie Proof')) {
              label.innerHTML = 'ü§≥ Selfie Proof (Optional for first admin)';
            }
          });
        }
      } catch(e) {
        console.log('Could not check existing users:', e);
      }
    });

    // Override registerUser
    const originalRegisterUser = window.registerUser;
    window.registerUser = async function() {
      const name = (document.getElementById('regName')?.value || '').trim();
      const email = (document.getElementById('regEmail')?.value || '').trim().toLowerCase();
      const pass = (document.getElementById('regPass')?.value || '').trim();
      const confirmPass = (document.getElementById('regConfirmPass')?.value || '').trim();

      if(!name || !email || !pass) {
        return alert('Please fill all fields.');
      }

      if(pass.length < 4) {
        return alert('Password must be at least 4 characters.');
      }

      if(pass !== confirmPass) {
        return alert('‚ùå Passwords do not match! Please try again.');
      }

      // Check consent checkboxes
      const consentPromotions = document.getElementById('consentPromotions');
      const consentPrivacy = document.getElementById('consentPrivacy');
      const consentTerms = document.getElementById('consentTerms');

      if (!consentPromotions.checked || !consentPrivacy.checked || !consentTerms.checked) {
        return alert('Please accept all terms and conditions to continue.');
      }

      // Check if this is first user (becomes admin)
      let isFirstUser = false;
      try {
        const checkResponse = await fetch('/users');
        const existingUsers = await checkResponse.json();
        if (existingUsers.length === 0) {
          isFirstUser = true;
          // Update message
          const msgEl = document.getElementById('regMessage');
          if (msgEl) {
            msgEl.innerHTML = 'üëë You will be the first admin! No approval needed.';
            msgEl.style.color = '#4caf50';
          }
        }
      } catch(e) {
        console.log('Could not check existing users:', e);
      }

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name, 
            email, 
            password: pass
          })
        });

        const data = await response.json();
        
        if(response.ok) {
          // Check if this was the first user (admin)
          if (isFirstUser) {
            alert('‚úÖ Admin account created successfully! You can now login.');
          } else {
            alert('‚úÖ Registration successful! Your account is pending admin approval. You will be notified once approved.');
          }
          location.href = 'index.html';
        } else {
          alert(data.detail || 'Registration failed');
        }
      } catch(error) {
        console.error('Registration error:', error);
        alert('Registration failed. Please try again.');
      }
    };
  </script>
</body>
</html>
