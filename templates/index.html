<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CanteenOS â€” Login</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/auth.css">
</head>
<body>
  <div class="auth-wrap">
    <div class="auth-card card">
      <h2 class="headline center">ğŸ½ï¸ RMLCanteen â€” Login</h2>

      <label class="input-label">Email</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" required>

      <label class="input-label">Password</label>
      <div class="password-row">
        <input type="password" id="loginPass" placeholder="Enter your password" required>
        <button type="button" onclick="togglePasswordVisibility('loginPass', 'loginPassToggle')" id="loginPassToggle" title="Show password">ğŸ‘ï¸</button>
      </div>

      <button class="btn mt-8" onclick="handleLogin()" id="loginBtn">Login</button>
      
      <div id="loginError" style="display: none; color: #e74c3c; margin-top: 10px; text-align: center; font-size: 0.9rem;"></div>

      <p class="center mt-8 muted">
        Don't have an account? <a href="register.html" class="link">Register</a>
      </p>
    </div>
  </div>

  <script src="/static/script.js"></script>
  <script>
    // if already logged in -> redirect to appropriate page
    (function(){
      const cur = getCurrent();
      if(cur && cur.role === 'admin') location.href='admin.html';
      if(cur && cur.role === 'user') location.href='order.html';
    })();
    
    // Check approval status for pending users (polling)
    let approvalCheckInterval = null;
    async function checkUserApprovalStatus() {
      const emailInput = document.getElementById('loginEmail');
      if(!emailInput || !emailInput.value) return;
      
      try {
        // Try to login to check approval status (without actually logging in)
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: emailInput.value.trim().toLowerCase(),
            password: document.getElementById('loginPass')?.value || ''
          })
        });
        
        if(response.status === 403) {
          // Still pending - continue polling
          return;
        } else if(response.ok) {
          // User was approved! Show notification
          const data = await response.json();
          if(data.is_approved !== false && data.is_approved !== 0) {
            // Stop polling
            if(approvalCheckInterval) {
              clearInterval(approvalCheckInterval);
              approvalCheckInterval = null;
            }
            
            // Show success message
            const errorDiv = document.getElementById('loginError');
            if(errorDiv) {
              errorDiv.style.display = 'block';
              errorDiv.style.color = '#4CAF50';
              errorDiv.style.background = '#e8f5e9';
              errorDiv.style.padding = '12px';
              errorDiv.style.borderRadius = '8px';
              errorDiv.style.border = '2px solid #4CAF50';
              errorDiv.textContent = 'âœ… Your account has been approved! You can now login.';
            }
          }
        }
      } catch(e) {
        // Ignore errors
      }
    }
    
    // Start checking approval status if user has entered email
    document.addEventListener('DOMContentLoaded', function() {
      const emailInput = document.getElementById('loginEmail');
      if(emailInput) {
        emailInput.addEventListener('blur', function() {
          // When user leaves email field, start checking if they're waiting for approval
          if(this.value.trim()) {
            // Check immediately
            checkUserApprovalStatus();
            // Then check every 10 seconds
            if(approvalCheckInterval) {
              clearInterval(approvalCheckInterval);
            }
            approvalCheckInterval = setInterval(checkUserApprovalStatus, 10000);
          }
        });
      }
    });

    function togglePasswordVisibility(inputId, buttonId){
      const input = document.getElementById(inputId);
      const button = document.getElementById(buttonId);
      if(input && button) {
        if(input.type === 'password') {
          input.type = 'text';
          button.textContent = 'ğŸ™ˆ';
          button.title = 'Hide password';
        } else {
          input.type = 'password';
          button.textContent = 'ğŸ‘ï¸';
          button.title = 'Show password';
        }
      }
    }

    async function handleLogin(){
      const btn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('loginError');
      
      // Disable button and show loading
      if(btn) {
        btn.disabled = true;
        btn.textContent = 'Logging in...';
      }
      if(errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }
      
      try {
        // delegates to script.js login function
        await loginUser();
      } catch(error) {
        console.error('Login handler error:', error);
        if(errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = 'Login failed. Please try again.';
        }
      } finally {
        // Re-enable button
        if(btn) {
          btn.disabled = false;
          btn.textContent = 'Login';
        }
      }
    }
    
    // Allow Enter key to submit
    document.addEventListener('DOMContentLoaded', function() {
      const emailInput = document.getElementById('loginEmail');
      const passInput = document.getElementById('loginPass');
      
      if(emailInput && passInput) {
        [emailInput, passInput].forEach(input => {
          input.addEventListener('keypress', function(e) {
            if(e.key === 'Enter') {
              handleLogin();
            }
          });
        });
      }
    });
  </script>
</body>
</html>
